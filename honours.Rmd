---
title: "honours"
output: html_document
date: "2025-05-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
pak::pak("christelinda-laureijs/patchclampplotteR")
```
## Libraries
libraries I might need
```{r}
library(patchclampplotteR)
library(dplyr)
library(ggplot2)
library(ggsignif)
library(ggtext)
library(ggforce)
library(ggpubr)
library(here)
```
## Importing Data
Importing Cell Characteristics
```{r}
cell_characteristics <- import_cell_characteristics_df("Data/Cell-Characteristics.csv")

cell_characteristics
```

Importing Sheet with Raw Evoked Current Data
```{r eval=FALSE}
eEPSC_data <- read.csv("Data/new_raw.csv")

eEPSC_data
```

To Append New Data onto the EXISTING SHEET (raw_eEPSC_df.csv) after first time
```{r eval=FALSE}
# will not run if there is nothing new in "new_raw.csv" so if you put new data directly into "raw_eEPSC_df.csv", it won't run
add_new_cells(
  new_raw_data_csv = "Data/new_raw.csv", # should ONLY have the new data you want
  cell_characteristics_csv = "Data/Cell-Characteristics.csv",
  old_raw_data_csv = "Data/raw_eEPSC_df.csv",
  data_type = "eEPSC",
  write_new_csv = "yes",
  new_file_name = "Data/raw_eEPSC_df.csv", # will overwrite the current version of this file
  decimal_places = 2
)

# once successful, go delete the data from "new_raw.csv" so that you don't get a duplication error the next time you are adding data to the raw_eEPSC_df.
```

Look at the data frame
```{r}
raw_eEPSC_df <- read.csv(here("Data/raw_eEPSC_df.csv")) # puts it in the environment

raw_eEPSC_df # prints it
```
Importing NEW Action Potential Count Data
```{r eval=FALSE}
add_new_cells(
  new_raw_data_csv = "Data/new_AP_count.csv", # should ONLY have the new data you want
  cell_characteristics_csv = "Data/Cell-Characteristics.csv",
  old_raw_data_csv = "Data/AP_count_data.csv", # current data
  data_type = "AP_count",
  write_new_csv = "yes",
  new_file_name = "Data/AP_count_data.csv", # will add to this and overwrite the current version of this file
  decimal_places = 2,
  injection_start_time = 265.4,
  length_of_current_injection = 0.5
)
```
```{r}
AP_count_data <- read.csv(here("Data/AP_count_data.csv"))
```

Importing NEW Action Potential Parameter Data
```{r eval=FALSE}
add_new_cells(
  new_raw_data_csv = "Data/new_AP_parameters.csv", # should ONLY have the new data you want,
  cell_characteristics_csv = "Data/Cell-Characteristics.csv",
  old_raw_data_csv = "Data/AP_parameters.csv", # current data
  data_type = "AP_parameter",
  write_new_csv = "yes",
  new_file_name = "Data/AP_parameters.csv", # will add to this and overwrite the current version of this file (same as current data)
  decimal_places = 2,
  injection_start_time = 265.4,
  length_of_current_injection = 0.5
)
```
```{r}
AP_data <- read.csv(here("Data/AP_parameters.csv"))
```

## Theme and Colour Options
defining my colour theme
```{r}
my_theme_colours <- data.frame(
  category = c(1, 2, 3, 2),
    treatment = c("Control", "Control", "Control", "AM251"),
  display_names = c("Naive", "Acute", "Repeated", "Acute with AM251"),
  colours = c("#ecc479", "#eb647e", "#005b96", "#C11C84"),
  very_pale_colours = c("#f5e0b3", "#f19cac", "#6497b1", "#FFADFF")
)
```

editing my theme options
```{r}
library(tibble)

my_theme_options <- read.csv("Data/my_custom_theme_options.csv") %>%
  remove_rownames() %>%
  column_to_rownames(var = "option")
```

## How many cells, and how long are they?
```{r}
# acute
raw_eEPSC_df %>%
  filter(category == 2) %>%
  filter(time == 0) %>%
  group_by(treatment) %>%
  count(sex) %>%
  arrange(treatment, sex)
```
```{r}
# naive
raw_eEPSC_df %>%
  filter(category == 1) %>%
  filter(time == 0) %>%
  group_by(treatment) %>%
  count(sex) %>%
  arrange(treatment, sex)
```
```{r}
# repeated
raw_eEPSC_df %>%
  filter(category == 3) %>%
  filter(time == 0) %>%
  group_by(treatment) %>%
  count(sex) %>%
  arrange(treatment, sex)
```

Length of Cells
```{r}
raw_eEPSC_df %>%
  group_by(letter) %>%
  summarize(max_time = max(time))
```

## Raw Plots per Cell
Normalizing Data:
```{r}
normalized_raw_eEPSC_df <- make_normalized_EPSC_data(
  filename = "Data/raw_eEPSC_df.csv",
  current_type = "eEPSC",
  min_time_value = 0,
  max_time_value = 30,
  interval_length = 5,
  baseline_length = 5,
  negative_transform_currents = "yes" # because the raw amplitudes are negative
)
```

Raw ACUTE Plots for each cell:
```{r}
raw_eEPSC_acute_plots <- plot_raw_current_data(
 data = normalized_raw_eEPSC_df, # why are RMA3 and RMA4 not showing up (May 2025)
 # no longer filtering bad cells RMA5 and RMA7 (2025/6/16)
  plot_treatment = "Control", # RMA3 and RMA4 were not showing up because they had "control" instead of "Control" and "female" instead of "Female" (May 2025)
  plot_category = 2, # 2 is acute restraint, 1 is naive
  current_type = "eEPSC",
  y_variable = "P1",
  pruned = "no",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

 raw_eEPSC_acute_plots
```
Raw ACUTE Plots for each cell with AM251:
```{r}
raw_eEPSC_acute_plots_AM251 <- plot_raw_current_data(
 data = normalized_raw_eEPSC_df,
  plot_treatment = "AM251",
  plot_category = 2, # 2 is acute restraint, 1 is naive
  current_type = "eEPSC",
  y_variable = "P1",
  pruned = "no",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

 raw_eEPSC_acute_plots_AM251

```

Raw Naive Plots for each cell:
```{r}
raw_eEPSC_naive_plots <- plot_raw_current_data(
 data = normalized_raw_eEPSC_df,
  plot_treatment = "Control",
  plot_category = 1,
  current_type = "eEPSC",
  y_variable = "P1",
  pruned = "no",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

 raw_eEPSC_naive_plots

# remove the title ("Recording LS10") and subtitle ("Treatment: Control Sex: Female")
# LS10_plot <- raw_eEPSC_naive_plots$LS10 + theme(plot.subtitle = element_blank(), plot.title = element_blank())

# LS10_plot

#fixing the y-axis
# LS10_final_plot <- LS10_plot + ylim(0,550)

# LS10_final_plot

# saving as png to figure folder
#ggsave(LS10_final_plot, path = here("Figures"), file = "LS10_final_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```

Raw REPEATED Plots for each cell:
```{r}
raw_eEPSC_repeated_plots <- plot_raw_current_data(
 data = normalized_raw_eEPSC_df, # why are RMA3 and RMA4 not showing up (May 2025)
 # no longer filtering bad cells RMA5 and RMA7 (2025/6/16)
  plot_treatment = "Control", # RMA3 and RMA4 were not showing up because they had "control" instead of "Control" and "female" instead of "Female" (May 2025)
  plot_category = 3, # 3 is repeated, 2 is acute restraint, 1 is naive
  current_type = "eEPSC",
  y_variable = "P1",
  pruned = "no",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

 raw_eEPSC_repeated_plots
```
## Pruned Plots per Cell
Prune full cells from the normalized raw data:
```{r}
# pruning averages data per minute

pruned_eEPSC_df <- make_pruned_EPSC_data(
  data = normalized_raw_eEPSC_df,
  current_type = "eEPSC",
  min_time_value = 0,
  max_time_value = 30,
  baseline_length = 5,
  interval_length = 1
)

pruned_eEPSC_df$individual_cells
```


Plot Pruned NAIVE Data
```{r}
pruned_eEPSC_naive_plots <- plot_raw_current_data(
  data = pruned_eEPSC_df$individual_cells,
  plot_treatment = "Control",
  plot_category = 1,
  current_type = "eEPSC",
  y_variable = "mean_P1",
  pruned = "yes",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

pruned_eEPSC_naive_plots
```
Plot Pruned ACUTE Data
```{r}
pruned_eEPSC_acute_plots <- plot_raw_current_data(
  data = pruned_eEPSC_df$individual_cells,
  plot_treatment = "Control",
  plot_category = 2,
  current_type = "eEPSC",
  y_variable = "mean_P1",
  pruned = "yes",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

pruned_eEPSC_acute_plots
```


Plot Pruned ACUTE Data with AM251
```{r}
pruned_eEPSC_acute_plots_AM251 <- plot_raw_current_data(
  data = pruned_eEPSC_df$individual_cells,
  plot_treatment = "AM251",
  plot_category = 2,
  current_type = "eEPSC",
  y_variable = "mean_P1",
  pruned = "yes",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

pruned_eEPSC_acute_plots_AM251
```
Plot Pruned REPEATED Data
```{r}
pruned_eEPSC_repeated_plots <- plot_raw_current_data(
  data = pruned_eEPSC_df$individual_cells,
  plot_treatment = "Control",
  plot_category = 3,
  current_type = "eEPSC",
  y_variable = "mean_P1",
  pruned = "yes",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

pruned_eEPSC_repeated_plots
```
## Summary Plots
Summary DATA
```{r}
summary_eEPSC_df <- make_summary_EPSC_data(
  data = normalized_raw_eEPSC_df, # not pruned
  current_type = "eEPSC",
  save_output_as_RDS = "no",
  baseline_interval = "t0to5",
  ending_interval = "t25to30"
)
summary_eEPSC_df # what I will use in my summary data stuff and plots from now on

# gives percent change, mean, and SE

# Summary Plots (use PRUNED data, for visual ease, but t-tests are done with the SUMMARY data)

# Category 1 is naive, 2 is acute
```

### testing assumptions
testing assumptions for naive FEMALE summary data
```{r}
naive_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Female") %>% filter(category == "1") %>% filter(treatment == "Control") %>%
  mutate(
    naive_difference0to5_vs_25to30 = t25to30 - t0to5,
    naive_difference0to5_vs_20to25 = t20to25 - t0to5,
    naive_difference0to5_vs_15to20 = t15to20 - t0to5,
    naive_difference0to5_vs_10to15 = t10to15 - t0to5,
    naive_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(naive_difference_evoked_df$naive_difference0to5_vs_25to30)

shapiro.test(naive_difference_evoked_df$naive_difference0to5_vs_20to25)

shapiro.test(naive_difference_evoked_df$naive_difference0to5_vs_15to20)

shapiro.test(naive_difference_evoked_df$naive_difference0to5_vs_10to15)

shapiro.test(naive_difference_evoked_df$naive_difference0to5_vs_5to10)

# all p-values are greater than 0.05 -> fail to reject the null hypothesis that they are normally distributed -> the data is normally distributed
```
testing assumptions for naive MALE summary data
```{r}
male_naive_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Male") %>% filter(category == "1") %>% filter(treatment == "Control") %>%
  mutate(
    male_naive_difference0to5_vs_25to30 = t25to30 - t0to5,
    male_naive_difference0to5_vs_20to25 = t20to25 - t0to5,
    male_naive_difference0to5_vs_15to20 = t15to20 - t0to5,
    male_naive_difference0to5_vs_10to15 = t10to15 - t0to5,
    male_naive_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(male_naive_difference_evoked_df$male_naive_difference0to5_vs_25to30)

shapiro.test(male_naive_difference_evoked_df$male_naive_difference0to5_vs_20to25)

shapiro.test(male_naive_difference_evoked_df$male_naive_difference0to5_vs_15to20)

shapiro.test(male_naive_difference_evoked_df$male_naive_difference0to5_vs_10to15)

shapiro.test(male_naive_difference_evoked_df$male_naive_difference0to5_vs_5to10)

# all p-values are greater than 0.05 -> fail to reject the null hypothesis that they are normally distributed -> the data is normally distributed
```

testing assumptions for ACUTE FEMALE summary data
```{r}
acute_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Female") %>% filter(category == "2") %>% filter(treatment == "Control") %>%
  mutate(
    acute_difference0to5_vs_25to30 = t25to30 - t0to5,
    acute_difference0to5_vs_20to25 = t20to25 - t0to5,
    acute_difference0to5_vs_15to20 = t15to20 - t0to5,
    acute_difference0to5_vs_10to15 = t10to15 - t0to5,
    acute_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(acute_difference_evoked_df$acute_difference0to5_vs_25to30) # not showing up
qqnorm(acute_difference_evoked_df$acute_difference0to5_vs_25to30)
qqline(acute_difference_evoked_df$acute_difference0to5_vs_25to30)

shapiro.test(acute_difference_evoked_df$acute_difference0to5_vs_20to25) # normal
qqnorm(acute_difference_evoked_df$acute_difference0to5_vs_20to25)
qqline(acute_difference_evoked_df$acute_difference0to5_vs_20to25)

shapiro.test(acute_difference_evoked_df$acute_difference0to5_vs_15to20) # normal
qqnorm(acute_difference_evoked_df$acute_difference0to5_vs_15to20)
qqline(acute_difference_evoked_df$acute_difference0to5_vs_15to20)

shapiro.test(acute_difference_evoked_df$acute_difference0to5_vs_10to15) # normal
qqnorm(acute_difference_evoked_df$acute_difference0to5_vs_10to15)
qqline(acute_difference_evoked_df$acute_difference0to5_vs_10to15)

shapiro.test(acute_difference_evoked_df$acute_difference0to5_vs_5to10) # NOT normal
qqnorm(acute_difference_evoked_df$acute_difference0to5_vs_5to10)
qqline(acute_difference_evoked_df$acute_difference0to5_vs_5to10)

# the 5 to 10 minute and 25 to 30 minute periods have p-values less than 0.05 are are not normal
```
testing assumptions for ACUTE FEMALE summary data with AM251
```{r}
am251_acute_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Female") %>% filter(category == "2") %>% filter(treatment == "AM251") %>%
  mutate(
    am251_acute_difference0to5_vs_25to30 = t25to30 - t0to5,
    am251_acute_difference0to5_vs_20to25 = t20to25 - t0to5,
    am251_acute_difference0to5_vs_15to20 = t15to20 - t0to5,
    am251_acute_difference0to5_vs_10to15 = t10to15 - t0to5,
    am251_acute_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_25to30) # normal

shapiro.test(am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_20to25) # normal

shapiro.test(am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_15to20) # normal

shapiro.test(am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_10to15) # normal

shapiro.test(am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_5to10) # NOT normal

# the 5 to 10 minute have p-values less than 0.05 are are not normal
```

testing assumptions for ACUTE MALE summary data
```{r}
male_acute_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Male") %>% filter(category == "2") %>% filter(treatment == "Control") %>%
  mutate(
    male_acute_difference0to5_vs_25to30 = t25to30 - t0to5,
    male_acute_difference0to5_vs_20to25 = t20to25 - t0to5,
    male_acute_difference0to5_vs_15to20 = t15to20 - t0to5,
    male_acute_difference0to5_vs_10to15 = t10to15 - t0to5,
    male_acute_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(male_acute_difference_evoked_df$male_acute_difference0to5_vs_25to30) # not normal
shapiro.test(male_acute_difference_evoked_df$male_acute_difference0to5_vs_20to25) # not normal
shapiro.test(male_acute_difference_evoked_df$male_acute_difference0to5_vs_15to20) # normal
shapiro.test(male_acute_difference_evoked_df$male_acute_difference0to5_vs_10to15) # normal
shapiro.test(male_acute_difference_evoked_df$male_acute_difference0to5_vs_5to10) # not normal
```

### t-test for summary plots
```{r}
t_test_female_naive <-perform_t_tests_for_summary_plot(
  data = summary_eEPSC_df$summary_data %>% filter(sex == "Female"),
  test_category = 1,
  include_all_treatments = "no",
  list_of_treatments = c("Control"),
  current_type = "eEPSC",
  parameter = "amplitude",
  baseline_interval = "t0to5",
  interval_length = 5,
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

t_test_male_naive <-perform_t_tests_for_summary_plot(
  data = summary_eEPSC_df$summary_data %>% filter(sex == "Male"),
  test_category = 1,
  include_all_treatments = "no",
  list_of_treatments = c("Control"),
  current_type = "eEPSC",
  parameter = "amplitude",
  baseline_interval = "t0to5",
  interval_length = 5,
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

t_test_female_acute <-perform_t_tests_for_summary_plot(
  data = summary_eEPSC_df$summary_data %>% filter(sex == "Female"),
  test_category = 2,
  include_all_treatments = "no",
  list_of_treatments = c("Control"),
  current_type = "eEPSC",
  parameter = "amplitude",
  baseline_interval = "t0to5",
  interval_length = 5,
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

t_test_female_acute_am251 <-perform_t_tests_for_summary_plot(
  data = summary_eEPSC_df$summary_data %>% filter(sex == "Female"), 
  test_category = 2,
  include_all_treatments = "no",
  list_of_treatments = c("AM251"),
  current_type = "eEPSC",
  parameter = "amplitude",
  baseline_interval = "t0to5",
  interval_length = 5,
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

t_test_male_acute <-perform_t_tests_for_summary_plot(
  data = summary_eEPSC_df$summary_data %>% filter(sex == "Male"), 
  test_category = 2,
  include_all_treatments = "no",
  list_of_treatments = c("Control"),
  current_type = "eEPSC",
  parameter = "amplitude",
  baseline_interval = "t0to5",
  interval_length = 5,
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

#t_test_female_repeated <-perform_t_tests_for_summary_plot(
  #data = summary_eEPSC_df$summary_data %>% filter(sex == "Female"), 
  #test_category = 3,
  #include_all_treatments = "no",
  #list_of_treatments = c("Control"),
  #current_type = "eEPSC",
  #parameter = "amplitude",
  #baseline_interval = "t0to5",
  #interval_length = 5,
  #treatment_colour_theme = my_theme_colours,
  #save_output_as_RDS = "no"
#)


t_test_female_naive
t_test_male_naive
t_test_female_acute
t_test_female_acute_am251
t_test_male_acute
#t_test_female_repeated
```


Summary Plots (use PRUNED data, for visual ease, but t-tests are done with the SUMMARY data)
### plots
Naive FEMALE Summary:
```{r}
naive_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells,
  plot_category = 1,
  plot_treatment = "Control",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "female",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_female_naive,
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none")

naive_summary_plot

# saving as png to figure folder
# ggsave(naive_summary_plot, path = here("Figures"), file = "naive_summary_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```
Naive MALE Summary:
```{r}
male_naive_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells,
  plot_category = 1,
  plot_treatment = "Control",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "male",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_male_naive,
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none")

male_naive_summary_plot

# ggsave(male_naive_summary_plot, path = here("Figures"), file = "naive_summary_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```

Acute FEMALE Summary:
```{r}
acute_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells, 
  plot_category = 2,
  plot_treatment = "Control",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "female",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_female_acute, # proper t-test
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none") keeping this hashed out keeps the n = # label in

acute_summary_plot

# saving as png to figure folder
# ggsave(acute_summary_plot, path = here("Figures"), file = "acute_summary_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```

Acute FEMALE Summary with AM251:
```{r}
am251_acute_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells, 
  plot_category = 2,
  plot_treatment = "AM251",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "female",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_female_acute_am251, 
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none") keeping this hashed out keeps the n = # label in

am251_acute_summary_plot

# ggsave(am251_acute_summary_plot, path = here("Figures"), file = "am251_acute_summary_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```

REPEATED FEMALE Summary:
```{r}
repeated_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells, 
  plot_category = 3,
  plot_treatment = "Control",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "female",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_female_acute_am251, # need an actual one
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none") keeping this hashed out keeps the n = # label in

repeated_summary_plot
```

Acute MALE Summary:
```{r}
male_acute_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells, 
  plot_category = 2,
  plot_treatment = "Control",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "male",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_male_acute, # proper t-test
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none") keeping this hashed out keeps the n = # label in

male_acute_summary_plot

# ggsave(male_acute_summary_plot, path = here("Figures"), file = "male_acute_summary_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```
## Evoked Analysis
### Percent Change
percent change in amplitude during starting interval (baseline) vs ending
```{r}
plot_percent_change_comparisons(
  data = summary_eEPSC_df$percent_change_data,
  plot_category = 2,
  current_type = "eEPSC",
  y_variable = "amplitude",
  include_all_treatments = "yes",
  list_of_treatments = NULL,
  included_sexes = "female",
  male_label = "Male",
  female_label = "Female",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```
```{r}
plot_percent_change_comparisons(
  data = summary_eEPSC_df$percent_change_data,
  plot_category = 1,
  current_type = "eEPSC",
  y_variable = "amplitude",
  include_all_treatments = "yes",
  list_of_treatments = NULL,
  included_sexes = "both",
  # facet_by_sex = "yes",
  male_label = "Male",
  female_label = "Female",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```

### PPR
Make PPR Dataset
```{r}
PPR_df <- make_PPR_data(
  data = normalized_raw_eEPSC_df,
  include_all_treatments = "yes",
  list_of_treatments = NULL,
  PPR_min = 0,
  PPR_max = 5,
  baseline_interval = "t0to5",
  treatment_colour_theme = my_theme_colours
)
PPR_df
```
PPR multiple treatments for acute FEMALES
```{r}
plot_PPR_data_multiple_treatments(
  data = PPR_df,
  include_all_treatments = "yes",
  included_sexes = "female",
  plot_category = 2,
  baseline_label = "Baseline",
  post_hormone_label = "HFS",
  test_type = "t.test",
  # significance_display_method = "stars",
  geom_signif_family = "",
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours,
  save_plot_png = "no"
)
```
female vs male acute PPR HFS
```{r}
plot_PPR_data_single_treatment(
  data = PPR_df,
  plot_treatment = "Control",
  plot_category = 2,
  baseline_label = "Baseline",
  post_hormone_label = "HFS",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  test_type = "t.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

# sig increase in the PPR after HFS
# higher PPR means lower probability of release
```
female vs male naive PPR HFS
```{r}
plot_PPR_data_single_treatment(
  data = PPR_df,
  plot_treatment = "Control",
  plot_category = 1,
  baseline_label = "Baseline",
  post_hormone_label = "HFS",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  test_type = "t.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```

testing assumptions for comparing PPR during baseline
```{r}
PPR_plot_df <- PPR_df %>% # making the data frame so that we have mean PPR
  filter(state == "Baseline") %>%
  group_by(category, letter) %>%
  summarize(mean_PPR = mean(PPR),
            n = n())

shapiro.test(PPR_plot_df$mean_PPR) # testing assumptions using the mean PPR

# p value is greater than 0.05, data is normal
```
### AP Frequency
AP Frequencies for Multiple Treatments
```{r}
plot_AP_frequencies_multiple_treatments(
  data = AP_count_data,
  include_all_treatments = "no",
  list_of_treatments = c("Control", "AM251"),
  plot_category = 2,
  included_sexes = "female",
  treatment_colour_theme = my_theme_colours
)
```

```{r}
plot_AP_frequencies_single_treatment(
  data = AP_count_data, # 
  plot_treatment = "Control",
  plot_category = 2, # Acute with only picro
  included_sexes = "female",
  baseline_label = "Baseline",
  hormone_added = "HFS",
  significance_display_method = "stars", # could be "p-values" or "stars"
  treatment_colour_theme = my_theme_colours,
  large_axis_text = "no",
  test_type = "wilcox.test", # need to test assumptions
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```
```{r}
plot_AP_frequencies_single_treatment(
  data = AP_count_data, 
  plot_treatment = "AM251",
  plot_category = 2,
  included_sexes = "female",
  baseline_label = "Baseline",
  hormone_added = "HFS",
  significance_display_method = "stars", # could be "p-values" or "stars"
  treatment_colour_theme = my_theme_colours,
  large_axis_text = "no",
  test_type = "wilcox.test", # need to test assumptions
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```
### AP Amplitude
AP Amplitude: Acute Females 
```{r}
plot_AP_comparison(
  AP_data,
  plot_treatment = "Control",
  plot_category = 2,
  included_sexes = "female",
  facet_by_sex = "no",
  left_sex = "Female",
  y_variable = "peak_amplitude",
  y_axis_title = "Peak Amplitude (pA)",
  theme_options = my_theme_options,
  baseline_label = "Baseline",
  test_type = "wilcox.test",
  post_hormone_label = "HFS",
  treatment_colour_theme = my_theme_colours,
  save_plot_png = "no"
)
```
AP Amplitude: Acute Females with AM251
```{r}
plot_AP_comparison(
  AP_data,
  plot_treatment = "AM251",
  plot_category = 2,
  included_sexes = "female",
  facet_by_sex = "no",
  left_sex = "Female",
  y_variable = "peak_amplitude",
  y_axis_title = "Peak Amplitude (pA)",
  theme_options = my_theme_options,
  baseline_label = "Baseline",
  test_type = "wilcox.test",
  post_hormone_label = "HFS",
  treatment_colour_theme = my_theme_colours,
  save_plot_png = "no"
)
```

### Variance Analysis
Creating Variance dataset for variance analysis (category 2)
```{r}
variance_2_df <- make_variance_data(
  data = summary_eEPSC_df$summary_data,
  df_category = 2,
  include_all_treatments = "yes",
  list_of_treatments = NULL,
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

variance_2_df

# VARIANCE

# The strength of synaptic transmission onto a neuron depends on the number of functional vesicle release sites (N), the probability of vesicle release (Pr), and the quantal size (Q)

# 1/CV2 depends on N and Pr, but not on Q
# VMR depends on Pr and Q, but not on N
```
```{r}
variance_1_df <- make_variance_data(
  data = summary_eEPSC_df$summary_data,
  df_category = 1,
  include_all_treatments = "yes",
  list_of_treatments = NULL,
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

variance_1_df
```


Variance Comparisons for ACUTE (Control)
```{r}
cv_comparison_control_plot <- plot_variance_comparison_data(
  data = variance_2_df,
  plot_category = 2, # acute
  plot_treatment = "Control", # only picro
  variance_measure = "cv",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

vmr_comparison_control_plot <- plot_variance_comparison_data(
  data = variance_2_df,
  plot_category = 2, # acute
  plot_treatment = "Control", # only picro
  variance_measure = "VMR",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

cv_comparison_control_plot
vmr_comparison_control_plot

# With the almost significant decrease in VMR in males: 
# if it was significant, since there is no change in 1/CV2, it would be a presynaptic change in Q
```
Variance Comparisons for ACUTE (AM251)
```{r}
cv_comparison_AM251_plot <- plot_variance_comparison_data(
  data = variance_2_df,
  plot_category = 2, # acute
  plot_treatment = "AM251",
  variance_measure = "cv",
  included_sexes = "female", # no male data
  facet_by_sex = "no",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

vmr_comparison_AM251_plot <- plot_variance_comparison_data(
  data = variance_2_df,
  plot_category = 2, # acute
  plot_treatment = "AM251",
  variance_measure = "VMR",
  included_sexes = "female", # no male data
  facet_by_sex = "no",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

cv_comparison_AM251_plot
vmr_comparison_AM251_plot

# With the almost significant decrease in VMR in males: 
# if it was significant, since there is no change in 1/CV2, it would be a presynaptic change in Q
```

Variance Comparisons for NAIVE
```{r}
cv_comparison_naive_plot <- plot_variance_comparison_data(
  data = variance_1_df,
  plot_category = 1, 
  plot_treatment = "Control",
  variance_measure = "cv",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options
)

vmr_comparison_naive_plot <- plot_variance_comparison_data(
  data = variance_1_df,
  plot_category = 1, 
  plot_treatment = "Control",
  variance_measure = "VMR",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options
)

cv_comparison_naive_plot
vmr_comparison_naive_plot
```


