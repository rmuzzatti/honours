---
title: "honours"
output: html_document
date: "2025-05-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r eval=FALSE}
pak::pak("christelinda-laureijs/patchclampplotteR")
```
## Libraries
libraries I might need
```{r}
library(patchclampplotteR)
library(dplyr)
library(ggplot2)
library(ggsignif)
library(ggtext)
library(ggforce)
library(ggpubr)
library(here)
```
## Importing Data
Importing Cell Characteristics
```{r}
cell_characteristics <- import_cell_characteristics_df("Data/Cell-Characteristics.csv")

cell_characteristics
```

Importing Sheet with Raw Evoked Current Data
```{r}
eEPSC_data <- read.csv("Data/new_raw_eEPSC.csv")

eEPSC_data
```

### Raw eEPSC
To Append New Data onto the EXISTING SHEET (raw_eEPSC_df.csv) after first time
```{r eval=FALSE}
# will not run if there is nothing new in "new_raw_eEPSC.csv" so if you put new data directly into "raw_eEPSC_df.csv", it won't run
add_new_cells(
  new_raw_data_csv = "Data/new_raw_eEPSC.csv", # should ONLY have the new data you want
  cell_characteristics_csv = "Data/Cell-Characteristics.csv",
  old_raw_data_csv = "Data/raw_eEPSC_df.csv",
  data_type = "eEPSC",
  write_new_csv = "yes",
  new_file_name = "Data/raw_eEPSC_df.csv", # will overwrite the current version of this file
  decimal_places = 2
)

# once successful, go delete the data from "new_raw_eEPSC.csv" so that you don't get a duplication error the next time you are adding data to the raw_eEPSC_df.
```

Look at the data frame
```{r}
raw_eEPSC_df <- read.csv(here("Data/raw_eEPSC_df.csv")) # puts it in the environment

raw_eEPSC_df # prints it
```

### AP Count
Importing NEW Action Potential Count Data
```{r eval=FALSE}
add_new_cells(
  new_raw_data_csv = "Data/new_AP_count.csv", # should ONLY have the new data you want
  cell_characteristics_csv = "Data/Cell-Characteristics.csv",
  old_raw_data_csv = "Data/AP_count_data.csv", # current data
  data_type = "AP_count",
  write_new_csv = "yes",
  new_file_name = "Data/AP_count_data.csv", # will add to this and overwrite the current version of this file
  decimal_places = 2,
  injection_start_time = 265.4,
  length_of_current_injection = 0.5
)
```
```{r}
AP_count_data <- read.csv(here("Data/AP_count_data.csv"))
```

### AP Parameters
Importing NEW Action Potential Parameter Data
```{r eval=FALSE}
add_new_cells(
  new_raw_data_csv = "Data/new_AP_parameters.csv", # should ONLY have the new data you want,
  cell_characteristics_csv = "Data/Cell-Characteristics.csv",
  old_raw_data_csv = "Data/AP_parameters.csv", # current data
  data_type = "AP_parameter",
  write_new_csv = "yes",
  new_file_name = "Data/AP_parameters.csv", # will add to this and overwrite the current version of this file (same as current data)
  decimal_places = 2,
  injection_start_time = 265.4,
  length_of_current_injection = 0.5
)
```
```{r}
AP_data <- read.csv(here("Data/AP_parameters.csv"))
```

## Theme and Colour Options
defining my colour theme
```{r}
my_theme_colours <- data.frame(
  category = c(1, 2, 3, 2),
    treatment = c("Control", "Control", "Control", "AM251"),
  display_names = c("Naive", "Acute", "Repeated", "Acute with AM251"),
  colours = c("#ecc479", "#eb647e", "#005b96", "#C11C84"),
  very_pale_colours = c("#f5e0b3", "#f19cac", "#6497b1", "#FFADFF")
)
```

editing my theme options
```{r}
library(tibble)

my_theme_options <- read.csv("Data/my_custom_theme_options.csv") %>%
  remove_rownames() %>%
  column_to_rownames(var = "option")
```

## How many cells, and how long are they?
```{r}
# acute
raw_eEPSC_df %>%
  filter(category == 2) %>%
  filter(time == 0) %>%
  group_by(treatment) %>%
  count(sex) %>%
  arrange(treatment, sex)
```
```{r}
# naive
raw_eEPSC_df %>%
  filter(category == 1) %>%
  filter(time == 0) %>%
  group_by(treatment) %>%
  count(sex) %>%
  arrange(treatment, sex)
```
```{r}
# repeated
raw_eEPSC_df %>%
  filter(category == 3) %>%
  filter(time == 0) %>%
  group_by(treatment) %>%
  count(sex) %>%
  arrange(treatment, sex)
```

Length of Cells
```{r}
raw_eEPSC_df %>%
  group_by(letter) %>%
  summarize(max_time = max(time))
```

## Raw Plots per Cell
Normalizing Data:
```{r}
normalized_raw_eEPSC_df <- make_normalized_EPSC_data(
  filename = "Data/raw_eEPSC_df.csv",
  current_type = "eEPSC",
  min_time_value = 0,
  max_time_value = 30,
  interval_length = 5,
  baseline_length = 5,
  negative_transform_currents = "yes" # because the raw amplitudes are negative
)
```

Raw ACUTE Plots for each cell:
```{r}
raw_eEPSC_acute_plots <- plot_raw_current_data(
 data = normalized_raw_eEPSC_df, # why are RMA3 and RMA4 not showing up (May 2025)
 # no longer filtering bad cells RMA5 and RMA7 (2025/6/16)
  plot_treatment = "Control", # RMA3 and RMA4 were not showing up because they had "control" instead of "Control" and "female" instead of "Female" (May 2025)
  plot_category = 2, # 2 is acute restraint, 1 is naive
  current_type = "eEPSC",
  y_variable = "P1",
  pruned = "no",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

 raw_eEPSC_acute_plots
```
Raw ACUTE Plots for each cell with AM251:
```{r}
raw_eEPSC_acute_plots_AM251 <- plot_raw_current_data(
 data = normalized_raw_eEPSC_df,
  plot_treatment = "AM251",
  plot_category = 2, # 2 is acute restraint, 1 is naive
  current_type = "eEPSC",
  y_variable = "P1",
  pruned = "no",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

 raw_eEPSC_acute_plots_AM251

```

Raw Naive Plots for each cell:
```{r}
raw_eEPSC_naive_plots <- plot_raw_current_data(
 data = normalized_raw_eEPSC_df,
  plot_treatment = "Control",
  plot_category = 1,
  current_type = "eEPSC",
  y_variable = "P1",
  pruned = "no",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

 raw_eEPSC_naive_plots

# remove the title ("Recording LS10") and subtitle ("Treatment: Control Sex: Female")
# LS10_plot <- raw_eEPSC_naive_plots$LS10 + theme(plot.subtitle = element_blank(), plot.title = element_blank())

# LS10_plot

#fixing the y-axis
# LS10_final_plot <- LS10_plot + ylim(0,550)

# LS10_final_plot

# saving as png to figure folder
#ggsave(LS10_final_plot, path = here("Figures"), file = "LS10_final_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```

Raw REPEATED Plots for each cell:
```{r}
raw_eEPSC_repeated_plots <- plot_raw_current_data(
 data = normalized_raw_eEPSC_df, # why are RMA3 and RMA4 not showing up (May 2025)
 # no longer filtering bad cells RMA5 and RMA7 (2025/6/16)
  plot_treatment = "Control", # RMA3 and RMA4 were not showing up because they had "control" instead of "Control" and "female" instead of "Female" (May 2025)
  plot_category = 3, # 3 is repeated, 2 is acute restraint, 1 is naive
  current_type = "eEPSC",
  y_variable = "P1",
  pruned = "no",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

 raw_eEPSC_repeated_plots
```
## Pruned Plots per Cell
Prune full cells from the normalized raw data:
```{r}
# pruning averages data per minute

pruned_eEPSC_df <- make_pruned_EPSC_data(
  data = normalized_raw_eEPSC_df,
  current_type = "eEPSC",
  min_time_value = 0,
  max_time_value = 30,
  baseline_length = 5,
  interval_length = 1
)

pruned_eEPSC_df$individual_cells
```


Plot Pruned NAIVE Data
```{r}
pruned_eEPSC_naive_plots <- plot_raw_current_data(
  data = pruned_eEPSC_df$individual_cells,
  plot_treatment = "Control",
  plot_category = 1,
  current_type = "eEPSC",
  y_variable = "mean_P1",
  pruned = "yes",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

pruned_eEPSC_naive_plots
```
Plot Pruned ACUTE Data
```{r}
pruned_eEPSC_acute_plots <- plot_raw_current_data(
  data = pruned_eEPSC_df$individual_cells,
  plot_treatment = "Control",
  plot_category = 2,
  current_type = "eEPSC",
  y_variable = "mean_P1",
  pruned = "yes",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

pruned_eEPSC_acute_plots
```


Plot Pruned ACUTE Data with AM251
```{r}
pruned_eEPSC_acute_plots_AM251 <- plot_raw_current_data(
  data = pruned_eEPSC_df$individual_cells,
  plot_treatment = "AM251",
  plot_category = 2,
  current_type = "eEPSC",
  y_variable = "mean_P1",
  pruned = "yes",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

pruned_eEPSC_acute_plots_AM251
```
Plot Pruned REPEATED Data
```{r}
pruned_eEPSC_repeated_plots <- plot_raw_current_data(
  data = pruned_eEPSC_df$individual_cells,
  plot_treatment = "Control",
  plot_category = 3,
  current_type = "eEPSC",
  y_variable = "mean_P1",
  pruned = "yes",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  theme_options = my_theme_options,
  treatment_colour_theme = my_theme_colours
)

pruned_eEPSC_repeated_plots

# MR11, MR12, maybe MR7 baselines might be questionable
```
## Summary Plots
Summary DATA
```{r}
summary_eEPSC_df <- make_summary_EPSC_data(
  data = normalized_raw_eEPSC_df, # not pruned
  current_type = "eEPSC",
  save_output_as_RDS = "no",
  baseline_interval = "t0to5",
  ending_interval = "t25to30"
)
summary_eEPSC_df # what I will use in my summary data stuff and plots from now on

# gives percent change, mean, and SE

# Summary Plots (use PRUNED data, for visual ease, but t-tests are done with the SUMMARY data)

# Category 1 is naive, 2 is acute
```

### testing assumptions
testing assumptions for naive FEMALE summary data
```{r}
naive_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Female") %>% filter(category == "1") %>% filter(treatment == "Control") %>%
  mutate(
    naive_difference0to5_vs_25to30 = t25to30 - t0to5,
    naive_difference0to5_vs_20to25 = t20to25 - t0to5,
    naive_difference0to5_vs_15to20 = t15to20 - t0to5,
    naive_difference0to5_vs_10to15 = t10to15 - t0to5,
    naive_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(naive_difference_evoked_df$naive_difference0to5_vs_25to30)

shapiro.test(naive_difference_evoked_df$naive_difference0to5_vs_20to25)

shapiro.test(naive_difference_evoked_df$naive_difference0to5_vs_15to20)

shapiro.test(naive_difference_evoked_df$naive_difference0to5_vs_10to15)

shapiro.test(naive_difference_evoked_df$naive_difference0to5_vs_5to10)

# all p-values are greater than 0.05 -> fail to reject the null hypothesis that they are normally distributed -> the data is normally distributed


bartlett.test(list(naive_difference_evoked_df$naive_difference0to5_vs_25to30, naive_difference_evoked_df$naive_difference0to5_vs_20to25, naive_difference_evoked_df$naive_difference0to5_vs_15to20, naive_difference_evoked_df$naive_difference0to5_vs_10to15, naive_difference_evoked_df$naive_difference0to5_vs_5to10))

# p-value is greater than 0.05 -> cannot reject the null hypothesis that the variances are equal -> variances are equal
```


testing assumptions for naive MALE summary data
```{r}
male_naive_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Male") %>% filter(category == "1") %>% filter(treatment == "Control") %>%
  mutate(
    male_naive_difference0to5_vs_25to30 = t25to30 - t0to5,
    male_naive_difference0to5_vs_20to25 = t20to25 - t0to5,
    male_naive_difference0to5_vs_15to20 = t15to20 - t0to5,
    male_naive_difference0to5_vs_10to15 = t10to15 - t0to5,
    male_naive_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(male_naive_difference_evoked_df$male_naive_difference0to5_vs_25to30)

shapiro.test(male_naive_difference_evoked_df$male_naive_difference0to5_vs_20to25)

shapiro.test(male_naive_difference_evoked_df$male_naive_difference0to5_vs_15to20)

shapiro.test(male_naive_difference_evoked_df$male_naive_difference0to5_vs_10to15)

shapiro.test(male_naive_difference_evoked_df$male_naive_difference0to5_vs_5to10)

# all p-values are greater than 0.05 -> fail to reject the null hypothesis that they are normally distributed -> the data is normally distributed

bartlett.test(list(male_naive_difference_evoked_df$male_naive_difference0to5_vs_25to30, male_naive_difference_evoked_df$male_naive_difference0to5_vs_20to25, male_naive_difference_evoked_df$male_naive_difference0to5_vs_15to20, male_naive_difference_evoked_df$male_naive_difference0to5_vs_10to15, male_naive_difference_evoked_df$male_naive_difference0to5_vs_5to10))

# p-value is greater than 0.05 -> cannot reject the null hypothesis that the variances are equal -> variances are equal
```

testing assumptions for ACUTE FEMALE summary data
```{r}
acute_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Female") %>% filter(category == "2") %>% filter(treatment == "Control") %>%
  mutate(
    acute_difference0to5_vs_25to30 = t25to30 - t0to5,
    acute_difference0to5_vs_20to25 = t20to25 - t0to5,
    acute_difference0to5_vs_15to20 = t15to20 - t0to5,
    acute_difference0to5_vs_10to15 = t10to15 - t0to5,
    acute_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(acute_difference_evoked_df$acute_difference0to5_vs_25to30) # not showing up
qqnorm(acute_difference_evoked_df$acute_difference0to5_vs_25to30)
qqline(acute_difference_evoked_df$acute_difference0to5_vs_25to30)

shapiro.test(acute_difference_evoked_df$acute_difference0to5_vs_20to25) # normal
qqnorm(acute_difference_evoked_df$acute_difference0to5_vs_20to25)
qqline(acute_difference_evoked_df$acute_difference0to5_vs_20to25)

shapiro.test(acute_difference_evoked_df$acute_difference0to5_vs_15to20) # normal
qqnorm(acute_difference_evoked_df$acute_difference0to5_vs_15to20)
qqline(acute_difference_evoked_df$acute_difference0to5_vs_15to20)

shapiro.test(acute_difference_evoked_df$acute_difference0to5_vs_10to15) # normal
qqnorm(acute_difference_evoked_df$acute_difference0to5_vs_10to15)
qqline(acute_difference_evoked_df$acute_difference0to5_vs_10to15)

shapiro.test(acute_difference_evoked_df$acute_difference0to5_vs_5to10) # NOT normal
qqnorm(acute_difference_evoked_df$acute_difference0to5_vs_5to10)
qqline(acute_difference_evoked_df$acute_difference0to5_vs_5to10)

# the 5 to 10 minute and 25 to 30 minute periods have p-values less than 0.05 are are not normal


bartlett.test(list(acute_difference_evoked_df$acute_difference0to5_vs_25to30, acute_difference_evoked_df$acute_difference0to5_vs_20to25, acute_difference_evoked_df$acute_difference0to5_vs_15to20, acute_difference_evoked_df$acute_difference0to5_vs_10to15, acute_difference_evoked_df$acute_difference0to5_vs_5to10))

# p-value is greater than 0.05 -> cannot reject the null hypothesis that the variances are equal -> variances are equal
```

testing assumptions for ACUTE FEMALE summary data with AM251
```{r}
am251_acute_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Female") %>% filter(category == "2") %>% filter(treatment == "AM251") %>%
  mutate(
    am251_acute_difference0to5_vs_25to30 = t25to30 - t0to5,
    am251_acute_difference0to5_vs_20to25 = t20to25 - t0to5,
    am251_acute_difference0to5_vs_15to20 = t15to20 - t0to5,
    am251_acute_difference0to5_vs_10to15 = t10to15 - t0to5,
    am251_acute_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_25to30) # normal

shapiro.test(am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_20to25) # normal

shapiro.test(am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_15to20) # normal

shapiro.test(am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_10to15) # normal

shapiro.test(am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_5to10) # NOT normal

# the 5 to 10 minute have p-values less than 0.05 are are not normal


bartlett.test(list(am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_25to30, am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_20to25, am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_15to20, am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_10to15, am251_acute_difference_evoked_df$am251_acute_difference0to5_vs_5to10))

  # p-value is LESS than 0.05 -> variances are NOT equal
```

testing assumptions for ACUTE MALE summary data
```{r}
male_acute_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Male") %>% filter(category == "2") %>% filter(treatment == "Control") %>%
  mutate(
    male_acute_difference0to5_vs_25to30 = t25to30 - t0to5,
    male_acute_difference0to5_vs_20to25 = t20to25 - t0to5,
    male_acute_difference0to5_vs_15to20 = t15to20 - t0to5,
    male_acute_difference0to5_vs_10to15 = t10to15 - t0to5,
    male_acute_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(male_acute_difference_evoked_df$male_acute_difference0to5_vs_25to30) # not normal
shapiro.test(male_acute_difference_evoked_df$male_acute_difference0to5_vs_20to25) # not normal
shapiro.test(male_acute_difference_evoked_df$male_acute_difference0to5_vs_15to20) # normal
shapiro.test(male_acute_difference_evoked_df$male_acute_difference0to5_vs_10to15) # normal
shapiro.test(male_acute_difference_evoked_df$male_acute_difference0to5_vs_5to10) # not normal


bartlett.test(list(male_acute_difference_evoked_df$male_acute_difference0to5_vs_25to30, male_acute_difference_evoked_df$male_acute_difference0to5_vs_20to25, male_acute_difference_evoked_df$male_acute_difference0to5_vs_15to20, male_acute_difference_evoked_df$male_acute_difference0to5_vs_10to15, male_acute_difference_evoked_df$male_acute_difference0to5_vs_5to10))

# p-value is greater than 0.05 -> cannot reject the null hypothesis that the variances are equal -> variances are equal
```

testing assumptions for REPEATED female summary data
```{r}
rr_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Female") %>% filter(category == "3") %>% filter(treatment == "Control") %>%
  mutate(
    rr_difference0to5_vs_25to30 = t25to30 - t0to5,
    rr_difference0to5_vs_20to25 = t20to25 - t0to5,
    rr_difference0to5_vs_15to20 = t15to20 - t0to5,
    rr_difference0to5_vs_10to15 = t10to15 - t0to5,
    rr_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(rr_difference_evoked_df$rr_difference0to5_vs_25to30) 
shapiro.test(rr_difference_evoked_df$rr_difference0to5_vs_20to25) 
shapiro.test(rr_difference_evoked_df$rr_difference0to5_vs_15to20) 
shapiro.test(rr_difference_evoked_df$rr_difference0to5_vs_10to15) 
shapiro.test(rr_difference_evoked_df$rr_difference0to5_vs_5to10) 

# all p-values are greater than 0.05 -> fail to reject the null hypothesis that they are normally distributed -> the data is normally distributed


bartlett.test(list(rr_difference_evoked_df$rr_difference0to5_vs_25to30, rr_difference_evoked_df$rr_difference0to5_vs_20to25, rr_difference_evoked_df$rr_difference0to5_vs_15to20, rr_difference_evoked_df$rr_difference0to5_vs_10to15, rr_difference_evoked_df$rr_difference0to5_vs_5to10))

# p-value is greater than 0.05 -> cannot reject the null hypothesis that the variances are equal -> variances are equal
```
testing assumptions for REPEATED male summary data
```{r}
male_rr_difference_evoked_df <- summary_eEPSC_df$percent_change_data %>% filter(sex == "Male") %>% filter(category == "3") %>% filter(treatment == "Control") %>%
  mutate(
    male_rr_difference0to5_vs_25to30 = t25to30 - t0to5,
    male_rr_difference0to5_vs_20to25 = t20to25 - t0to5,
    male_rr_difference0to5_vs_15to20 = t15to20 - t0to5,
    male_rr_difference0to5_vs_10to15 = t10to15 - t0to5,
    male_rr_difference0to5_vs_5to10 = t5to10 - t0to5,
         )

shapiro.test(male_rr_difference_evoked_df$male_rr_difference0to5_vs_25to30) 
shapiro.test(male_rr_difference_evoked_df$male_rr_difference0to5_vs_20to25) 
shapiro.test(male_rr_difference_evoked_df$male_rr_difference0to5_vs_15to20) 
shapiro.test(male_rr_difference_evoked_df$male_rr_difference0to5_vs_10to15) 
shapiro.test(male_rr_difference_evoked_df$male_rr_difference0to5_vs_5to10) 

# NONE of p-values are less than 0.05 -> reject the null hypothesis that they are normally distributed -> the data is NOT normally distributed


bartlett.test(list(male_rr_difference_evoked_df$male_rr_difference0to5_vs_25to30, male_rr_difference_evoked_df$male_rr_difference0to5_vs_20to25, male_rr_difference_evoked_df$male_rr_difference0to5_vs_15to20, male_rr_difference_evoked_df$male_rr_difference0to5_vs_10to15, male_rr_difference_evoked_df$male_rr_difference0to5_vs_5to10))

# p-value is greater than 0.05 -> cannot reject the null hypothesis that the variances are equal -> variances are equal
```

### t-test for summary plots
```{r}
t_test_female_naive <-perform_t_tests_for_summary_plot(
  data = summary_eEPSC_df$summary_data %>% filter(sex == "Female"),
  test_category = 1,
  include_all_treatments = "no",
  list_of_treatments = c("Control"),
  current_type = "eEPSC",
  parameter = "amplitude",
  baseline_interval = "t0to5",
  interval_length = 5,
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

t_test_male_naive <-perform_t_tests_for_summary_plot(
  data = summary_eEPSC_df$summary_data %>% filter(sex == "Male"),
  test_category = 1,
  include_all_treatments = "no",
  list_of_treatments = c("Control"),
  current_type = "eEPSC",
  parameter = "amplitude",
  baseline_interval = "t0to5",
  interval_length = 5,
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

t_test_female_acute <-perform_t_tests_for_summary_plot(
  data = summary_eEPSC_df$summary_data %>% filter(sex == "Female"),
  test_category = 2,
  include_all_treatments = "no",
  list_of_treatments = c("Control"),
  current_type = "eEPSC",
  parameter = "amplitude",
  baseline_interval = "t0to5",
  interval_length = 5,
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

t_test_female_acute_am251 <-perform_t_tests_for_summary_plot(
  data = summary_eEPSC_df$summary_data %>% filter(sex == "Female"), 
  test_category = 2,
  include_all_treatments = "no",
  list_of_treatments = c("AM251"),
  current_type = "eEPSC",
  parameter = "amplitude",
  baseline_interval = "t0to5",
  interval_length = 5,
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

t_test_male_acute <-perform_t_tests_for_summary_plot(
  data = summary_eEPSC_df$summary_data %>% filter(sex == "Male"), 
  test_category = 2,
  include_all_treatments = "no",
  list_of_treatments = c("Control"),
  current_type = "eEPSC",
  parameter = "amplitude",
  baseline_interval = "t0to5",
  interval_length = 5,
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

t_test_female_repeated <-perform_t_tests_for_summary_plot(
  data = summary_eEPSC_df$summary_data %>% filter(sex == "Female"), 
  test_category = 3,
  include_all_treatments = "no",
  list_of_treatments = c("Control"),
  current_type = "eEPSC",
  parameter = "amplitude",
  baseline_interval = "t0to5",
  interval_length = 5,
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)


t_test_female_naive
t_test_male_naive
t_test_female_acute
t_test_female_acute_am251
t_test_male_acute
t_test_female_repeated
```


Summary Plots (use PRUNED data, for visual ease, but t-tests are done with the SUMMARY data)
### summary plots
Naive FEMALE Summary:
```{r}
naive_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells,
  plot_category = 1,
  plot_treatment = "Control",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "female",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_female_naive,
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none")

naive_summary_plot

# saving as png to figure folder
ggsave(naive_summary_plot, path = here("Figures"), file = "naive_summary_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```

Naive MALE Summary:
```{r}
male_naive_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells,
  plot_category = 1,
  plot_treatment = "Control",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "male",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_male_naive,
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none")

male_naive_summary_plot

ggsave(male_naive_summary_plot, path = here("Figures"), file = "male_naive_summary_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```

Acute FEMALE Summary:
```{r}
acute_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells, 
  plot_category = 2,
  plot_treatment = "Control",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "female",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_female_acute, # proper t-test
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none") keeping this hashed out keeps the n = # label in

acute_summary_plot

# saving as png to figure folder
# ggsave(acute_summary_plot, path = here("Figures"), file = "acute_summary_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```
FEMALE TREATMENT 1 COMBINED
```{r}
female_treatment1_plot <- pruned_eEPSC_df$all_cells %>%
  filter(sex == "Female" & category %in% c(1,2) & treatment == "Control") %>%
  ggplot(aes(x = time, y = mean_P1_all_cells, ymin = mean_P1_all_cells - se_P1_all_cells, ymax = mean_P1_all_cells + se_P1_all_cells, colour = category)) +
  geom_pointrange(size = 0.9, shape = 16) +
  ylim(0,230) +
  labs(x = "Time (min)", y = "eEPSC Amplitude (% Baseline)", colour = NULL) + # NULL for legend heading
  geom_hline(yintercept = 100, linetype = "dashed") +
  scale_colour_manual(values = c("lightgrey", "#f19cac"), labels = c("Naive, n = 10", "Acute, n = 8")) + 
  
  # add naive t-test
  geom_text(
    data = t_test_female_naive,
    aes(
      x = asterisk_time,
      y = 50,
      label = significance_stars
    ),
    inherit.aes = FALSE,
    size = 8,
    colour = "lightgrey"
  ) +

  # add acute t-test
  geom_text(
    data = t_test_female_acute,
    aes(
      x = asterisk_time,
      y = 170,
      label = significance_stars
    ),
    inherit.aes = FALSE,
    size = 8,
    colour = "#eb647e"
  ) +
  
  # add HFS text
  annotate(
        geom = "text",
        x = 5,
        y = 220,
        label = "HFS",
        size = 4,
        hjust = 0.5
      ) +
  
  # add arrow
   annotate(
        geom = "segment",
        x = 5,
        y = 210,
        xend = 5,
        yend = 190,
        arrow = grid::arrow(type = "closed", length = grid::unit(0.02, "npc"))
      ) +
  patchclampplotteR_theme() +
  theme(
    legend.position = "inside",
    legend.position.inside = c(0.025, 0.05),
    legend.justification = c(0, 0)
  )

female_treatment1_plot

# ggsave(female_treatment1_plot, path = here("Figures"), file = "female_treatment1_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```

```{r}
female_stress_plot <- pruned_eEPSC_df$all_cells %>%
  filter(sex == "Female" & category %in% c(1,2,3) & treatment %in% c("Control","AM251")) %>%
  ggplot(aes(x = time, y = mean_P1_all_cells, ymin = mean_P1_all_cells - se_P1_all_cells, ymax = mean_P1_all_cells + se_P1_all_cells, colour = interaction(category, treatment))) +
  geom_pointrange(size = 0.9, shape = 16) +
  ylim(0,230) +
  labs(x = "Time (min)", y = "eEPSC Amplitude (% Baseline)", colour = NULL) + # NULL for legend heading
  geom_hline(yintercept = 100, linetype = "dashed") +
  scale_colour_manual(values = c("#FFADFF", "lightgrey", "#f19cac", "#6497b1"), labels = c("Acute with AM25", "Naive", "Acute", "Repeated")) + 
  
    # add acute t-test
  geom_text(
    data = t_test_female_acute,
    aes(
      x = asterisk_time,
      y = 170,
      label = significance_stars
    ),
    inherit.aes = FALSE,
    size = 8,
    colour = "#eb647e"
  ) +
  
  # add HFS text
  annotate(
        geom = "text",
        x = 5,
        y = 220,
        label = "HFS",
        size = 4,
        hjust = 0.5
      ) +
  
  # add arrow
   annotate(
        geom = "segment",
        x = 5,
        y = 210,
        xend = 5,
        yend = 190,
        arrow = grid::arrow(type = "closed", length = grid::unit(0.02, "npc"))
      ) +
  patchclampplotteR_theme() +
  
  theme(
    legend.position = "right",
    #legend.position.inside = c(0.025, 0.05),
    #legend.justification = c(0, 0)
  )

female_stress_plot
```


MALE TREATMENT 1 COMBINED
```{r}
male_treatment1_plot <- pruned_eEPSC_df$all_cells %>%
  filter(sex == "Male" & category %in% c(1,2) & treatment == "Control") %>%
  
  ggplot(aes(x = time, y = mean_P1_all_cells, ymin = mean_P1_all_cells - se_P1_all_cells, ymax = mean_P1_all_cells + se_P1_all_cells, colour = category)) +
  geom_pointrange(size = 0.9, shape = 17) +
  ylim(0,230) +
  labs(x = "Time (min)", y = "eEPSC Amplitude (% Baseline)", colour = NULL) + # NULL for legend heading
  geom_hline(yintercept = 100, linetype = "dashed") +
  scale_colour_manual(values = c("lightgrey", "#f19cac"), labels = c("Naive, n = 13", "Acute, n = 8")) +
  
  # add naive t-test
  geom_text(
    data = t_test_male_naive,
    aes(x = asterisk_time,
      y = 170,
      label = significance_stars
    ),
    inherit.aes = FALSE,
    size = 8,
    colour = "grey"
  ) +

  # add acute t-test
  geom_text(
    data = t_test_male_acute,
    aes(
      x = asterisk_time,
      y = 50,
      label = significance_stars
    ),
    inherit.aes = FALSE,
    size = 8,
    colour = "#eb647e"
  ) +
  
  # add HFS text
  annotate(
        geom = "text",
        x = 5,
        y = 220,
        label = "HFS",
        size = 4,
        hjust = 0.5
      ) +
  
  # add arrow  
  annotate(
        geom = "segment",
        x = 5,
        y = 210,
        xend = 5,
        yend = 190,
        arrow = grid::arrow(type = "closed", length = grid::unit(0.02, "npc"))
      ) +
  
  patchclampplotteR_theme() +
  theme(
    legend.position = "inside",
    legend.position.inside = c(0.025, 0.05),
    legend.justification = c(0, 0)
  )

male_treatment1_plot

# ggsave(male_treatment1_plot, path = here("Figures"), file = "male_treatment1_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```


Acute FEMALE Summary with AM251:
```{r}
am251_acute_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells, 
  plot_category = 2,
  plot_treatment = "AM251",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "female",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_female_acute_am251, 
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none") keeping this hashed out keeps the n = # label in

am251_acute_summary_plot

# ggsave(am251_acute_summary_plot, path = here("Figures"), file = "am251_acute_summary_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```

REPEATED FEMALE Summary:
```{r}
repeated_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells, 
  plot_category = 3,
  plot_treatment = "Control",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "female",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_female_repeated, 
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none") keeping this hashed out keeps the n = # label in

repeated_summary_plot

# ggsave(repeated_summary_plot, path = here("Figures"), file = "repeated_summary_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```
REPEATED MALE Summary:
```{r}
male_repeated_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells, 
  plot_category = 3,
  plot_treatment = "Control",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "male",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_female_repeated, # need own t-test but doesn't pass assumptions
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none") keeping this hashed out keeps the n = # label in

male_repeated_summary_plot
```


Acute MALE Summary:
```{r}
male_acute_summary_plot <- plot_summary_current_data(
  data = pruned_eEPSC_df$all_cells, 
  plot_category = 2,
  plot_treatment = "Control",
  current_type = "eEPSC",
  y_variable = "amplitude",
  hormone_added = "HFS",
  hormone_or_HFS_start_time = 5,
  included_sexes = "male",
  include_representative_trace = "no",
  representative_trace_filename = import_ext_data("Control-trace.png"),
  y_axis_limit = 230,
  signif_stars = "yes",
  geom_signif_text_size = 8,
  t_test_df = t_test_male_acute, # proper t-test
  large_axis_text = "no",
  legend_position = "inside",
  shade_intervals = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
) #+ theme(legend.position = "none") keeping this hashed out keeps the n = # label in

male_acute_summary_plot

# ggsave(male_acute_summary_plot, path = here("Figures"), file = "male_acute_summary_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```

## Baseline 
### eEPSC
```{r}
# data
female_baseline_amp_plot <- summary_eEPSC_df$percent_change_data %>%
  filter(sex == "Female" & category %in% c(1,2) & treatment %in% c("Control","AM251")) %>% 
  mutate(cat_treat = factor(
    interaction(category, treatment),
    levels = c("1.Control", "2.Control", "2.AM251")
  )) %>%
  
  ggplot(aes(x = cat_treat, y = t0to5)) +
  
  patchclampplotteR_theme() +
  
# axis labels
  labs(x = NULL, y = "Baseline eEPSC Amplitude (pA)") +
  patchclampplotteR_theme() +
  
# the boxes
  geom_boxplot(aes(fill = interaction(category, treatment), color = interaction(category, treatment)), 
               alpha = 0.6, 
               color = "black", # get rid of if want the dark colour to be the outline
# outlier.shape = NA stops the box plot from plotting outliers. BUT because the sina plot is a different layer, all outliers are still shown as dots from that.
               outlier.shape = NA, 
               width = 0.5, 
               show.legend = FALSE)  +
  
  # the dots/scatter plot
  geom_sina(aes(x = interaction(category, treatment), color = interaction(category, treatment)), 
            max_width = 0.2, 
            shape = 16, 
            size = 2, 
            show.legend = FALSE) +

  # colours
  scale_fill_manual(values = c("1.Control" = "#f5e0b3",
                               "2.Control" = "#f19cac",
                               "2.AM251" = "#ffadff")) +
  
  scale_color_manual(values = c("1.Control" = "#ecc479", 
                                "2.Control" = "#eb647e", 
                                "2.AM251" = "#c11c84")) +
  
  # x-axis labels  
scale_x_discrete(labels = c("Naive", "Acute", "Acute with AM251")) +
  
# x-axis subtitles  
  #annotate("text", x = 1, y = -0.2, label = "n = 10", size = 4, hjust = 0.4) + 
  #annotate("text", x = 2, y = -0.2, label = "n = 8", size = 4, hjust = 0.5) + 
  #annotate("text", x = 3, y = -0.2, label = "n = 10", size = 4, hjust = 0.5) +
  
  # t-test
  stat_compare_means(
    method = "t.test", 
    test.arg = list(paired = FALSE),
    label = "p.format", # p.signif does the stars, p.format shows the p-value
    comparisons = list(c("1.Control", "2.Control"), c("1.Control", "2.AM251")), # not sure if this is accurate...
    textsize = 5
) + 
  
  scale_y_continuous(expand = expansion(mult = c(0.2, .2))) +

  guides(fill = "none", color = "none")

female_baseline_amp_plot
```
eEPSC amplitude after the HFS (25-30 min)
```{r}
# data
female_HFS_amp_plot <- summary_eEPSC_df$percent_change_data %>%
  filter(sex == "Female" & category %in% c(1,2) & treatment %in% c("Control","AM251")) %>% 
  mutate(cat_treat = factor(
    interaction(category, treatment),
    levels = c("1.Control", "2.Control", "2.AM251")
  )) %>%
  
  ggplot(aes(x = cat_treat, y = t25to30)) +
  
  patchclampplotteR_theme() +
  
# axis labels
  labs(x = NULL, y = "FINAL eEPSC Amplitude (pA)") +
  patchclampplotteR_theme() +
  
# the boxes
  geom_boxplot(aes(fill = interaction(category, treatment), color = interaction(category, treatment)), 
               alpha = 0.6, 
               color = "black", # get rid of if want the dark colour to be the outline
# outlier.shape = NA stops the box plot from plotting outliers. BUT because the sina plot is a different layer, all outliers are still shown as dots from that.
               outlier.shape = NA, 
               width = 0.5, 
               show.legend = FALSE)  +
  
  # the dots/scatter plot
  geom_sina(aes(x = interaction(category, treatment), color = interaction(category, treatment)), 
            max_width = 0.2, 
            shape = 16, 
            size = 2, 
            show.legend = FALSE) +
  
  # mean as a point
  #stat_summary(fun = mean, geom = "point", 
               #shape = 16, size = 4, color = "black") +
  
  # colours
  scale_fill_manual(values = c("1.Control" = "#f5e0b3",
                               "2.Control" = "#f19cac",
                               "2.AM251" = "#ffadff")) +
  
  scale_color_manual(values = c("1.Control" = "#ecc479", 
                                "2.Control" = "#eb647e", 
                                "2.AM251" = "#c11c84")) +
  
  # x-axis labels  
scale_x_discrete(labels = c("Naive", "Acute", "Acute with AM251")) +
  
# x-axis subtitles  
  #annotate("text", x = 1, y = -0.2, label = "n = 10", size = 4, hjust = 0.4) + 
  #annotate("text", x = 2, y = -0.2, label = "n = 8", size = 4, hjust = 0.5) + 
  #annotate("text", x = 3, y = -0.2, label = "n = 10", size = 4, hjust = 0.5) +
  
  # t-test
  stat_compare_means(
    method = "t.test", 
    test.arg = list(paired = FALSE),
    label = "p.format", # p.signif does the stars, p.format shows the p-value
    comparisons = list(c("1.Control", "2.Control"), c("1.Control", "2.AM251")), # not sure if this is accurate...
    textsize = 5
) + 
  
  scale_y_continuous(expand = expansion(mult = c(0.2, .2))) +

  guides(fill = "none", color = "none")

female_HFS_amp_plot
```


### PPR
```{r}
# data
female_baseline_PPR_plot <- PPR_plot_df %>%
  filter(sex == "Female" & category %in% c(1,2) & treatment %in% c("Control","AM251")) %>% 
  mutate(cat_treat = factor(
    interaction(category, treatment),
    levels = c("1.Control", "2.Control", "2.AM251")
  )) %>%
  
  ggplot(aes(x = cat_treat, y = mean_PPR)) +
  
# axis labels
  labs(x = NULL, y = "Baseline Paired Pulse Ratio") +
  patchclampplotteR_theme() +
  theme(legend.position = "none") +
  
# the boxes
  geom_boxplot(aes(fill = interaction(category, treatment), color = interaction(category, treatment)), 
               alpha = 0.6, 
               color = "black", # get rid of if want the dark colour to be the outline
# outlier.shape = NA stops the box plot from plotting outliers. BUT because the sina plot is a different layer, all outliers are still shown as dots from that.
               outlier.shape = NA, 
               width = 0.5, 
               show.legend = FALSE)  +
  
  # the dots/scatter plot
  geom_sina(aes(x = interaction(category, treatment), color = interaction(category, treatment)), 
            max_width = 0.2, 
            shape = 16, 
            size = 2, 
            show.legend = FALSE) +
  
  # mean as a point
  # stat_summary(fun = mean, geom = "point", 
               # shape = 16, size = 4, color = "black") +
  
  # colours
  scale_fill_manual(values = c("1.Control" = "#f5e0b3",
                               "2.Control" = "#f19cac",
                               "2.AM251" = "#ffadff")) +
  
  scale_color_manual(values = c("1.Control" = "#ecc479", 
                                "2.Control" = "#eb647e", 
                                "2.AM251" = "#c11c84")) +
  
  # x-axis labels  
scale_x_discrete(labels = c("Naive", "Acute", "Acute with AM251")) +
  
# x-axis subtitles  
  #annotate("text", x = 1, y = -0.2, label = "n = 10", size = 4, hjust = 0.5) + 
  #annotate("text", x = 2, y = -0.2, label = "n = 8", size = 4, hjust = 0.5) + 
  #annotate("text", x = 3, y = -0.2, label = "n = 10", size = 4, hjust = 0.5) +
  
  # t-test
  stat_compare_means(
    method = "t.test", 
    test.arg = list(paired = FALSE),
    label = "p.format", # p.signif does the stars, p.format shows the p-value
    comparisons = list(c("1.Control", "2.Control"), c("1.Control", "2.AM251")), # not sure if this is accurate...
    textsize = 5
) +
  
  scale_y_continuous(expand = expansion(mult = c(0.2, .2))) +
  
  patchclampplotteR_theme() +

  guides(fill = "none", color = "none") 

female_baseline_PPR_plot
```







## Evoked Analysis
### Percent Change
percent change in amplitude during starting interval (baseline) vs ending
```{r}
plot_percent_change_comparisons(
  data = summary_eEPSC_df$percent_change_data,
  plot_category = 2,
  current_type = "eEPSC",
  y_variable = "amplitude",
  include_all_treatments = "yes",
  list_of_treatments = NULL,
  included_sexes = "female",
  male_label = "Male",
  female_label = "Female",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```
```{r}
plot_percent_change_comparisons(
  data = summary_eEPSC_df$percent_change_data,
  plot_category = 1,
  current_type = "eEPSC",
  y_variable = "amplitude",
  include_all_treatments = "yes",
  list_of_treatments = NULL,
  included_sexes = "both",
  # facet_by_sex = "yes",
  male_label = "Male",
  female_label = "Female",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```

### PPR
Make PPR Dataset
```{r}
PPR_df <- make_PPR_data(
  data = normalized_raw_eEPSC_df,
  include_all_treatments = "yes",
  list_of_treatments = NULL,
  PPR_min = 0,
  PPR_max = 5,
  baseline_interval = "t0to5",
  treatment_colour_theme = my_theme_colours
)
PPR_df
```

female vs male acute PPR HFS
```{r}
plot_PPR_data_single_treatment(
  data = PPR_df,
  plot_treatment = "Control",
  plot_category = 2,
  baseline_label = "Baseline",
  post_hormone_label = "HFS",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  test_type = "t.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

# sig increase in the PPR after HFS
# higher PPR means lower probability of release
```

female vs male naive PPR HFS
```{r}
plot_PPR_data_single_treatment(
  data = PPR_df,
  plot_treatment = "Control",
  plot_category = 1,
  baseline_label = "Baseline",
  post_hormone_label = "HFS",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  test_type = "t.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```
female vs male repeated PPR HFS
```{r}
plot_PPR_data_single_treatment(
  data = PPR_df,
  plot_treatment = "Control",
  plot_category = 3,
  baseline_label = "Baseline",
  post_hormone_label = "HFS",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  test_type = "t.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```

testing assumptions for comparing PPR during baseline
```{r}
PPR_plot_df <- PPR_df %>% # making the data frame so that we have mean PPR
  filter(state == "Baseline") %>%
  group_by(category, letter, treatment, sex) %>%
  summarize(mean_PPR = mean(PPR),
            n = n())

shapiro.test(PPR_plot_df$mean_PPR) # testing assumptions using the mean PPR

# p value is greater than 0.05, data is normal

# need to do bartlett's test ?
```
### AP Frequency
AP Frequencies for Multiple Treatments
```{r}
plot_AP_frequencies_multiple_treatments(
  data = AP_count_data,
  include_all_treatments = "no",
  list_of_treatments = c("Control", "AM251"),
  plot_category = 2,
  included_sexes = "female",
  treatment_colour_theme = my_theme_colours
)
```

```{r}
plot_AP_frequencies_single_treatment(
  data = AP_count_data, # 
  plot_treatment = "Control",
  plot_category = 2, # Acute with only picro
  included_sexes = "female",
  baseline_label = "Baseline",
  hormone_added = "HFS",
  significance_display_method = "stars", # could be "p-values" or "stars"
  treatment_colour_theme = my_theme_colours,
  large_axis_text = "no",
  test_type = "wilcox.test", # need to test assumptions
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```
```{r}
plot_AP_frequencies_single_treatment(
  data = AP_count_data, 
  plot_treatment = "AM251",
  plot_category = 2,
  included_sexes = "female",
  baseline_label = "Baseline",
  hormone_added = "HFS",
  significance_display_method = "stars", # could be "p-values" or "stars"
  treatment_colour_theme = my_theme_colours,
  large_axis_text = "no",
  test_type = "wilcox.test", # need to test assumptions, can be "wilcox.test", "t.test", or "none"
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```
```{r}
plot_AP_frequencies_single_treatment(
  data = AP_count_data, 
  plot_treatment = "Control",
  plot_category = 3,
  included_sexes = "female",
  baseline_label = "Baseline",
  hormone_added = "HFS",
  significance_display_method = "stars", # could be "p-values" or "stars"
  treatment_colour_theme = my_theme_colours,
  large_axis_text = "no",
  test_type = "none", # need to test assumptions, can be "wilcox.test", "t.test", or "none"
  theme_options = my_theme_options,
  save_plot_png = "no"
)

# why is baseline one less? I checked and they all have some APs eventually
```

### AP Amplitude
AP Amplitude: Acute Females 
```{r}
plot_AP_comparison(
  AP_data,
  plot_treatment = "Control",
  plot_category = 2,
  included_sexes = "female",
  facet_by_sex = "no",
  left_sex = "Female",
  y_variable = "peak_amplitude",
  y_axis_title = "Peak Amplitude (pA)",
  theme_options = my_theme_options,
  baseline_label = "Baseline",
  test_type = "wilcox.test",
  post_hormone_label = "HFS",
  treatment_colour_theme = my_theme_colours,
  save_plot_png = "no"
)
```
AP Amplitude: Acute Females with AM251
```{r}
plot_AP_comparison(
  AP_data,
  plot_treatment = "AM251",
  plot_category = 2,
  included_sexes = "female",
  facet_by_sex = "no",
  left_sex = "Female",
  y_variable = "peak_amplitude",
  y_axis_title = "Peak Amplitude (pA)",
  theme_options = my_theme_options,
  baseline_label = "Baseline",
  test_type = "wilcox.test",
  post_hormone_label = "HFS",
  treatment_colour_theme = my_theme_colours,
  save_plot_png = "no"
)
```

AP Amplitude: Repeated Females 
```{r}
plot_AP_comparison(
  AP_data,
  plot_treatment = "Control",
  plot_category = 3,
  included_sexes = "female",
  facet_by_sex = "no",
  left_sex = "Female",
  y_variable = "peak_amplitude",
  y_axis_title = "Peak Amplitude (pA)",
  theme_options = my_theme_options,
  baseline_label = "Baseline",
  test_type = "wilcox.test",
  post_hormone_label = "HFS",
  treatment_colour_theme = my_theme_colours,
  save_plot_png = "no"
)
```

### Variance Analysis
Creating Variance dataset for variance analysis (category 2)
```{r}
variance_2_df <- make_variance_data(
  data = summary_eEPSC_df$summary_data,
  df_category = 2,
  include_all_treatments = "yes",
  list_of_treatments = NULL,
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

variance_2_df

# VARIANCE

# The strength of synaptic transmission onto a neuron depends on the number of functional vesicle release sites (N), the probability of vesicle release (Pr), and the quantal size (Q)

# 1/CV2 depends on N and Pr, but not on Q
# VMR depends on Pr and Q, but not on N
```
```{r}
variance_1_df <- make_variance_data(
  data = summary_eEPSC_df$summary_data,
  df_category = 1,
  include_all_treatments = "yes",
  list_of_treatments = NULL,
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

variance_1_df
```
```{r}
variance_3_df <- make_variance_data(
  data = summary_eEPSC_df$summary_data,
  df_category = 3,
  include_all_treatments = "yes",
  list_of_treatments = NULL,
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  treatment_colour_theme = my_theme_colours,
  save_output_as_RDS = "no"
)

variance_3_df
```


Variance Comparisons for ACUTE (Control)
```{r}
cv_comparison_control_plot <- plot_variance_comparison_data(
  data = variance_2_df,
  plot_category = 2, # acute
  plot_treatment = "Control", # only picro
  variance_measure = "cv",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

vmr_comparison_control_plot <- plot_variance_comparison_data(
  data = variance_2_df,
  plot_category = 2, # acute
  plot_treatment = "Control", # only picro
  variance_measure = "VMR",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

cv_comparison_control_plot
vmr_comparison_control_plot

# With the almost significant decrease in VMR in males: 
# if it was significant, since there is no change in 1/CV2, it would be a presynaptic change in Q
```
Variance Comparisons for ACUTE (AM251)
```{r}
cv_comparison_AM251_plot <- plot_variance_comparison_data(
  data = variance_2_df,
  plot_category = 2, # acute
  plot_treatment = "AM251",
  variance_measure = "cv",
  included_sexes = "female", # no male data
  facet_by_sex = "no",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

vmr_comparison_AM251_plot <- plot_variance_comparison_data(
  data = variance_2_df,
  plot_category = 2, # acute
  plot_treatment = "AM251",
  variance_measure = "VMR",
  included_sexes = "female", # no male data
  facet_by_sex = "no",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

cv_comparison_AM251_plot
vmr_comparison_AM251_plot

# With the almost significant decrease in VMR in males: 
# if it was significant, since there is no change in 1/CV2, it would be a presynaptic change in Q
```
Variance Comparisons for REPEATED (Control)
```{r}
cv_comparison_repeated_plot <- plot_variance_comparison_data(
  data = variance_3_df,
  plot_category = 3, # repeated
  plot_treatment = "Control",
  variance_measure = "cv",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

vmr_comparison_repeated_plot <- plot_variance_comparison_data(
  data = variance_3_df,
  plot_category = 3, # repeated
  plot_treatment = "Control",
  variance_measure = "VMR",
  included_sexes = "both", 
  facet_by_sex = "yes",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)

cv_comparison_repeated_plot
vmr_comparison_repeated_plot

# RMR6 VMR after is the suddenly high one 

# With the significant decrease in VMR in repeated males, since there is no change in 1/CV2, it is a presynaptic change in Q
```

Variance Comparisons for NAIVE
```{r}
cv_comparison_naive_plot <- plot_variance_comparison_data(
  data = variance_1_df,
  plot_category = 1, 
  plot_treatment = "Control",
  variance_measure = "cv",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options
)

vmr_comparison_naive_plot <- plot_variance_comparison_data(
  data = variance_1_df,
  plot_category = 1, 
  plot_treatment = "Control",
  variance_measure = "VMR",
  included_sexes = "both",
  facet_by_sex = "yes",
  left_sex = "Female",
  baseline_interval = "t0to5",
  post_hormone_interval = "t25to30",
  post_hormone_label = "HFS",
  test_type = "wilcox.test",
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options
)

cv_comparison_naive_plot
vmr_comparison_naive_plot
```


PPR FOR POSTER
```{r}
plot_PPR_data_single_treatment(
  data = PPR_df,
  plot_treatment = "Control",
  plot_category = 2,
  baseline_label = "Baseline",
  post_hormone_label = "HFS",
    included_sexes = "female",
  #facet_by_sex = "yes",
  #left_sex = "Female",
  test_type = "t.test",
  map_signif_level_values = T,
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "yes"
)
```
```{r}
plot_PPR_data_single_treatment(
  data = PPR_df,
  plot_treatment = "Control",
  plot_category = 1,
  baseline_label = "Baseline",
  post_hormone_label = "HFS",
    included_sexes = "female",
  #facet_by_sex = "yes",
  #left_sex = "Female",
  test_type = "t.test",
  map_signif_level_values = T,
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "yes"
)
```
```{r}
plot_PPR_data_single_treatment(
  data = PPR_df,
  plot_treatment = "AM251",
  plot_category = 2,
  baseline_label = "Baseline",
  post_hormone_label = "HFS",
    included_sexes = "female",
  #facet_by_sex = "yes",
  #left_sex = "Female",
  test_type = "t.test",
  map_signif_level_values = T,
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "yes"
)
```

```{r}
plot_PPR_data_single_treatment(
  data = PPR_df,
  plot_treatment = "Control",
  plot_category = 3,
  baseline_label = "Baseline",
  post_hormone_label = "HFS",
    included_sexes = "female",
  #facet_by_sex = "yes",
  #left_sex = "Female",
  test_type = "t.test",
  map_signif_level_values = T,
  large_axis_text = "no",
  treatment_colour_theme = my_theme_colours,
  theme_options = my_theme_options,
  save_plot_png = "no"
)
```
### PPR female plot
```{r}
#1 facet labels
  facet_labels <- c(
    "1.Control.Female" = "Naive",
    "2.Control.Female" = "Acute",
    "2.AM251.Female" = "Acute with AM251",
    "3.Control.Female" = "Repeated")

#2 making the data frame for individual cells
female_PPR_plot_df <- PPR_df %>%
  filter(state %in% c("Baseline", "Post-modification")) %>% 
  filter(sex == "Female") %>% 
  mutate(
    state = ifelse(state == "Post-modification", "HFS", state)) %>% # rename to HFS
 mutate(facet_group = factor(interaction(category, treatment, sex),
                              levels = names(facet_labels))) %>%
  group_by(letter, state, category, treatment, sex, facet_group) %>%
  summarize(mean_PPR_cell = mean(PPR, na.rm = TRUE), .groups = "drop")  
   
#3 plot
female_PPR_plot <- female_PPR_plot_df %>%
  ggplot(aes(x = state, y = mean_PPR_cell)) + 

# individual  cells  
  geom_point(aes(shape = sex),size = 1, colour = "lightgrey") + 
  geom_line(aes(group = letter), colour = "lightgrey", alpha = 0.9) + 
  
# group mean
  stat_summary(aes(group = 1, colour = interaction(category, treatment)),
               fun.data = mean_se,
               geom = "line",
               linewidth = 1.2) +
  
  stat_summary(aes(group = 1,shape = sex,colour = interaction(category, treatment)),
    fun.data = mean_se,
    geom = "point",
    size = 2.5
  ) +  
 
# colours and shapes
  scale_colour_manual(values = c(
    "1.Control" = "#f5e0b3", # or "darkgrey"
    "2.Control" = "#f19cac",
    "2.AM251" = "#FFADFF",
    "3.Control" = "#6497b1"
  )) +
scale_shape_manual(values = c("Female" = 16, "Male" = 17)) +
  
# facet with labels and order
  facet_wrap(~ facet_group, labeller = as_labeller(facet_labels), nrow = 1) + # nrow = 1 makes it all on one line
  
# add significance brackets
  geom_signif(
    comparisons = list(c("Baseline", "HFS")),
    test = "t.test",
    test.args = list(paired = TRUE),
    map_signif_level = function(p)
        if (p <= 0.0001) {
          return("****")
        } else {
          if (p <= 0.001) {
            return("***")
          } else {
            if (p <= 0.01) {
              return("**")
            } else {
              if (p <= 0.05) {
                return("*")
              } else {
                if (p < 0.1 & p > 0.05) {
                  return(signif(p, 3))
                } else {
                  return("ns")
                }
              }
            }
          }
        }
, # or TRUE for stars, # FALSE for values
    vjust = -0.3,
    textsize = 5,
    size = 0.5,
    margin_top = 0.1,
    extend_line = 0.03
  ) +
  
# expand y-axis so the brackets don't overlap with labels
  scale_y_continuous(expand = expansion(mult = c(0.2, .2))) +
  
# theme and titles
  patchclampplotteR_theme() +
  labs(x = NULL, y = "PPR", title = NULL) +
  theme(legend.position = "none")  # remove legend

female_PPR_plot

# ggsave(female_PPR_plot, path = here("Figures"), file = "female_PPR_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```

### PPR female acute plot
```{r}
#1 facet labels
  facet_labels <- c(
    "1.Control.Female" = "Naive",
    "2.Control.Female" = "Acute",
    "2.AM251.Female" = "Acute with AM251")

#2 making the data frame for individual cells
female_acute_PPR_plot_df <- PPR_df %>%
  filter(state %in% c("Baseline", "Post-modification")) %>% 
  filter(sex == "Female") %>% 
  filter(category != 3) %>% # excluding category 3 (repeated), could also use category %in% c(1,2)
  mutate(
    state = ifelse(state == "Post-modification", "HFS", state)) %>% # rename to HFS
 mutate(facet_group = factor(interaction(category, treatment, sex),
                              levels = names(facet_labels))) %>%
  group_by(letter, state, category, treatment, sex, facet_group) %>%
  summarize(mean_PPR_cell = mean(PPR, na.rm = TRUE), .groups = "drop")  
   
#3 plot
female_acute_PPR_plot <- female_acute_PPR_plot_df %>%
  ggplot(aes(x = state, y = mean_PPR_cell)) + 

# individual  cells  
  geom_point(aes(shape = sex),size = 1, colour = "lightgrey") + 
  geom_line(aes(group = letter), colour = "lightgrey", alpha = 0.9) + 
  
# group mean
  stat_summary(aes(group = 1, colour = interaction(category, treatment)),
               fun.data = mean_se,
               geom = "line",
               linewidth = 1.2) +
  
  stat_summary(aes(group = 1,shape = sex,colour = interaction(category, treatment)),
    fun.data = mean_se,
    geom = "point",
    size = 2.5
  ) +   
 
# colours and shapes
  scale_colour_manual(values = c(
    "1.Control" = "#f5e0b3", # or "darkgrey"
    "2.Control" = "#f19cac",
    "2.AM251" = "#FFADFF"
  )) +
scale_shape_manual(values = c("Female" = 16, "Male" = 17)) +
  
# facet with labels and order
  facet_wrap(~ facet_group, labeller = as_labeller(facet_labels), nrow = 1) + # nrow = 1 makes it all on one line
  
# add significance brackets
  geom_signif(
    comparisons = list(c("Baseline", "HFS")),
    test = "t.test",
    test.args = list(paired = TRUE),
    map_signif_level = function(p)
        if (p <= 0.0001) {
          return("****")
        } else {
          if (p <= 0.001) {
            return("***")
          } else {
            if (p <= 0.01) {
              return("**")
            } else {
              if (p <= 0.05) {
                return("*")
              } else {
                if (p < 0.1 & p > 0.05) {
                  return(signif(p, 3))
                } else {
                  return("ns")
                }
              }
            }
          }
        }
, # or TRUE for stars, # FALSE for values
    vjust = -0.3,
    textsize = 5,
    size = 0.5,
    margin_top = 0.1,
    extend_line = 0.03
  ) +
  
# expand y-axis so the brackets don't overlap with labels
  scale_y_continuous(expand = expansion(mult = c(0.2, .2))) +
  
# theme and titles
  patchclampplotteR_theme() +
  labs(x = NULL, y = "PPR", title = NULL) +
  theme(legend.position = "none")  # remove legend

female_acute_PPR_plot

#ggsave(female_acute_PPR_plot, path = here("Figures"), file = "female_acute_PPR_plot.png", width = 7, height = 5, units = "in", dpi = 300)
```
### PPR with ALL SEXES AND TREATMENTS
```{r}
#1 facet labels
  facet_labels <- c(
    "1.Control.Female" = "Female Naive",
    "1.Control.Male" = "Male Naive",
    "2.Control.Female" = "Female Acute",
    "2.Control.Male" = "Male Acute",
    "2.AM251.Female" = "Acute with AM251",
    "3.Control.Female" = "Female Repeated",
    "3.Control.Male" = "Male Repeated")

#2 making the data frame for individual cells
PPR_plot_df <- PPR_df %>%
  filter(state %in% c("Baseline", "Post-modification")) %>% 
  mutate(
    state = ifelse(state == "Post-modification", "HFS", state)) %>% # rename to HFS
 mutate(facet_group = factor(interaction(category, treatment, sex),
                              levels = names(facet_labels))) %>%
  group_by(letter, state, category, treatment, sex, facet_group) %>%
  summarize(mean_PPR_cell = mean(PPR, na.rm = TRUE), .groups = "drop")  
   
#3 plot
PPR_plot <- PPR_plot_df %>%
  ggplot(aes(x = state, y = mean_PPR_cell)) + 

# individual  cells  
  geom_point(aes(shape = sex),size = 1, colour = "lightgrey") + 
  geom_line(aes(group = letter), colour = "lightgrey", alpha = 0.9) + 
  
# group mean
  stat_summary(aes(group = 1, colour = interaction(category, treatment)),
               fun.data = mean_se,
               geom = "line",
               linewidth = 1.2) +
  
  stat_summary(aes(group = 1,shape = sex,colour = interaction(category, treatment)),
    fun.data = mean_se,
    geom = "point",
    size = 2.5
  ) +  
 
# colours and shapes
  scale_colour_manual(values = c(
    "1.Control" = "#f5e0b3", # or "darkgrey"
    "2.Control" = "#f19cac",
    "2.AM251" = "#FFADFF",
    "3.Control" = "#6497b1"
  )) +
scale_shape_manual(values = c("Female" = 16, "Male" = 17)) +
  
# facet with labels and order
  facet_wrap(~ facet_group, labeller = as_labeller(facet_labels), nrow = 2) +
  
# add significance brackets
  geom_signif(
    comparisons = list(c("Baseline", "HFS")),
    test = "t.test",
    test.args = list(paired = TRUE),
    map_signif_level = function(p)
        if (p <= 0.0001) {
          return("****")
        } else {
          if (p <= 0.001) {
            return("***")
          } else {
            if (p <= 0.01) {
              return("**")
            } else {
              if (p <= 0.05) {
                return("*")
              } else {
                if (p < 0.1 & p > 0.05) {
                  return(signif(p, 3))
                } else {
                  return("ns")
                }
              }
            }
          }
        }
, # or TRUE for stars, # FALSE for values
    vjust = -0.3,
    textsize = 5,
    size = 0.5,
    margin_top = 0.1,
    extend_line = 0.03
  ) +
  
# expand y-axis so the brackets don't overlap with labels
  scale_y_continuous(expand = expansion(mult = c(0.2, .2))) +
  
# theme and titles
  patchclampplotteR_theme() +
  labs(x = NULL, y = "PPR", title = NULL) +
  theme(legend.position = "none")  # remove legend

PPR_plot
```
